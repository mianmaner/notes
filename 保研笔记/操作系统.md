#### 引论

##### 1. 操作系统

多数计算机有两种运⾏模式：==内核态（管态）和⽤户态（⽬态）==。软件中最基础的部分是操作系统，它运⾏在内核态。

操作系统四大特点：并发、共享、虚拟、异步

操作系统五大功能：处理机管理、内存管理、I/O 设备管理、文件管理、作业管理

操作系统结构设计：传统结构、C/S 模式、面向对象程序设计、微内核操作系统结构

##### 2. 系统调用

系统调用是操作系统提供给用户程序或应用程序的一组接口，用于访问操作系统的服务和资源。用户程序通常无法直接访问操作系统内核，因此必须通过系统调用来请求内核执行某些特权操作。

##### 3. 分时系统、实时系统

操作系统有两种：分时操作系统和实时操作系统

分时系统：为了弥补多道批处理系统交互性问题，引入分时系统，可以将一台计算机提供给多个用户同时使用，提高计算机利用率（主机共享、资源利用率高）

实时系统：系统能及时响应外部事件的请求，在规定时间内对该事件的处理，并控制所有实时任务协调一致的运行（实时响应、协调一致、安全可靠）

##### 4. 假脱机技术

> 什么是脱机：脱离主机的控制进行输入/输出操作

假脱机技术是指用软件的方式模拟脱机技术（也称 SPOOLing 技术），是一种将独占设备改造成共享设备的技术

三个组成部分：
①输入井和输出井
②输入缓冲和输出缓冲
③输入进程和输出进程

> 在磁盘上设置两个存储区域：输入井和输出井。输入井模拟脱机输入时的磁盘，用于收容 I/O 设备输入的数据；输出井模拟脱机输出时的磁盘，用于收容用户程序的输出数据。
>
> 在内存中设置两个缓冲区：输入缓冲区和输出缓冲区。输入缓冲区用于暂存输入设备送来的数据，以后再传送到输入井；输出缓冲区用于暂存输出井送来的数据，以后再传送到设备。
>
> 输入进程将用户要求的数据从输入机通过输入缓冲区再送到输入井，当 CPU 需要输入数据时，从输入井直接读入内存。输出进程把用户要求输出的数据先从内存送到输出井，待输出设备空闲，再将输出井中的数据通过输出缓冲区送到输出设备。
>
> SPOOLing 技术提高了 I/O 的速度，将独占设备改造成共享设备，实现了虚拟设备功能

##### 5. 中断、异常和陷入

简单来说，中断分为陷入、异常、外部中断，即这三者统称为中断（很多资料上中断特指外部中断，所以容易混淆）

中断（外部）：由 CPU 外部产生，是为了设备与CPU之间的通信
异常：由 CPU 当前正在执行的进程产生，CPU执行时出错
陷入：由 CPU 当前正在执行的进程产生，CPU 主动跳转，使程序进入某一条指令流

#### 进程和线程

##### 1. 进程和线程

**进程**：操作系统中能独立运行并作为资源分配的最小单位
**线程**：操作系统中能独立运行和系统调度的最小单位。一个进程包含若干线程，可利用进程的资源

**并发**：一个处理器同时处理多个任务，逻辑上的同时发生
**并行**：多个处理器同时处理多个任务，物理上的同时发生

进程的调度：抢占式、非抢占式
线程的类型：用户级别、内核级别、混合级别

##### 2. 进程的地址空间

进程的地址空间：多个代码段、数据段，但就一个栈段和堆段（栈段和堆段反方向，一个从高地址到低地址，一个从低地址到高地址）

##### 3. 进程的控制

**进程的状态**

就绪状态：进程已分配到除了 CPU 之外的所有必要资源
执行状态：进程已获得 CPU，程序正在运行
阻塞状态：进程的暂停状态

**进程的创建**

创建的时机：
① 系统初始化
② 一个进程调用系统调用来执行进程创建
③ 用户请求创建进程
④ 批作业处理

**进程的实现**

三个模块实现：
① **进程控制块 PCB**：记录操作系统所需的用于描述进程当前情况以及控制进程运行的全部信息
② 进程表：进程控制块的数组
③ 进程调度器

PCB 是进程存在与否的唯一标志，创建进程就是创建 PCB

##### 4. 进程间通讯

常见的进程间通讯是管道通讯、共享内存等

原语：由若干指令组成，用于完成一定功能的一个过程

(进程和线程共享内存都使用以下机制)

**概念**

竞态：两个线程竞争统一资源
临界区：程序获取共享内存的部分被称为临界区
进程关系：合作（直接相互制约）和资源共享（间接相互制约）

**信号量机制**

信号量机制可以让用户通过使用操作系统提供的**一对原语**来对**信号量**进行操作，从而方便地实现进程互斥和进程同步

信号量其实就是一个变量，它可以记录系统中某个资源的数量。而原语指的是 `wait(S)` 原语和 `signal(S)` 原语（或者说是 P 操作和 V 操作），可以看作是两个函数

互斥量可以当做特殊的信号量

##### 6. 进程调度与死锁

进程的调度：
① 抢占式：可以暂停正在执行的进程，将已分配给该进程的处理机重新分配给另一个进程
② 非抢占式：进程必须一直运行下去，知道完成才能将已分配给该进程的处理机重新分配给另一个进程

**死锁**：如果⼀个进程集合中的每个进程都在等待只能由该进程集合中的其他 进程才能引发的事件，那么，该进程集合就是死锁的
**活锁**：指线程无法取得需要的资源而一直重试的现象

> 死锁：多个进程拿住资源不放手。
> 活锁：多个进程同时松开资源，又同时请求资源，依然造成阻塞（例如行人一直谦让）

死锁发生的条件：
① 互斥访问 
② 持有资源仍索取资源 
③ 非抢占式 
④ 环路的等待

预防死锁的方式：虚拟化、假脱机、一次性全申请、资源编序

#### 内存管理

##### 1. 内存架构

缓存：小容量、快速度、昂贵
主存：中等容量、中等速度、中等价格

RAM：随机存取存储器（可读写）
ROM：只读存储器

##### 2. 连续分配管理方式

**固定分区分配**

此方式下用户内存被划分成若干个固定大小的区域，每个分区只装入一道作业，当有空闲分区时便从外存的后备作业队列中选择适当大小的作业装入分区

缺点：会造成内部碎片，浪费内存空间、存储空间利用率低

**动态分区分配**

在进程装入内存时，根据进程大小动态建立分区，使分区的大小适合进程的需要（动态分配并回收）

可变分区的结构：位图、链表

> 可变分区分配算法：
> ① 首次适应算法：空闲分区按照**地址递增**的顺序排列，分配内存时按顺序查找，找到第一个大小能满足进程的空闲分区，分配给进程使用。
> ② 最佳适应算法：空闲分区按照**容量递增**的顺序排列，分配内存时按顺序查找，找到第一个大小能满足进程的空闲分区，分配给进程使用。也即挑出满足要求且最小的空闲分区。
> ③ 最坏适应算法：空闲分区按照**容量递减**的顺序排列，分配内存时按顺序查找，找到第一个大小能满足进程的空闲分区，分配给进程使用。也即挑出满足要求且最大的空闲分区。又称最大适应算法。
> ④ 邻近适应算法：在首次适应算法的基础上，查找时从上一次查找结束的地方开始。又称循环首次适应算法。

##### 3. 离散分配管理方式

**分段方式（二维地址空间）**

基本思想：按照进程中的自然段划分逻辑空间，也即段的大小根据进程确定，不是固定的长度。但是一个程序可以根据需要分成多个段，段内连续，段间不连续。

段表：包含段号、段长、本段在内存中的起始地址，用于逻辑地址到物理地址的转换。

**分页方式（一维地址空间）**

基本思想：把主存空间划分成大小相等的块，一般大小为 2 的整数幂。块相对较小，作为主存的基本单位。进程中的块称为页，内存中的块称为页框，外存也以同样的大小划分，直接称为块

页表：页表实现了页号到物理块号的地址映射（每个页表项包含两个部分：页号和页号对应的物理块号）

> 快表：又称联想寄存器。快表是一个具有并行查找能力的高速缓冲存储器，又称联想寄存器，用来存放当前访问的若干页表项

##### 4. 虚拟内存管理

**虚拟内存**

每个地址拥有自己的地址空间，这个空间被分割成多个块，每个块都被称作一页或者页面。每一页有连续的地址范围，这些页被映射到物理内存，但并不是所有的页都必须在内存中才能运行程序，当需要时才执行必要的映射

**局部性原理**

时间局部性：如果一个信息项正在被访问，那么近期它很可能还会再次被访问
空间局部性：在最近的将来将用到的信息很可能与现在正在使用的信息在空间地址上是临近的

**缺页中断**

MMU（内存管理单元）：把进程的内存地址转换成物理内存的地址。页表就是一个内存管理单元

> MMU（内存管理单元）：把进程的内存地址转换成物理内存的地址。页表就是一个内存管理单元

缺页中断：当软件试图访问已映射在虚拟地址空间中，但是目前并未被加载在物理内存中的一个分页时，由内存管理单元发出的中断

缺页中断的中断处理程序会查找内存是否有空闲的块，若有空闲的块，则将所缺的页装入该块；若没有空闲的块，则需要替换掉某页

抖动：指刚刚换出的页面马上又换入主存，刚刚换入的页面马上又换出主存

**页面置换算法**

 R bit 集合：给最近读过的页面有再次保留的机会，访问位（R）位 0 则替换，访问位为1则置0

① 最优页面置换算法（OPT）：将未来最长时间未被使用的页替换掉
② FIFO 页面替换方法：将驻留时间最长的页替换掉
③ 二次机会页面替换算法：基于 FIFO + R bit 集合
④ NRU 替换算法（简单的时钟页面替换算法）：基于时钟 + R bit 集合（最近未使用）
⑤ **LRU 替换算法**：最近最久未使用

**工作集**

工作集是指在某段时间间隔 ∆ 里，进程实际要访问的页面的集合

工作集时钟页面转换算法：（目前操作系统一般使用的转换算法）

#### 文件管理

##### 1. 文件

系统运行的基本单位是进程，用户进程输入输出的基本单位是文件

文件的基本类型可分为字符型文件和二进制型文件

##### 2. 文件控制块

文件控制块 FCB 主要包含：文件基本信息、存取控制信息、使用信息

文件控制块的有序集合称为文件目录，创建一个新文件时，操作系统将分配一个 FCB 并存放在文件目录中，成为目录项

##### 3. 目录实现

目录实现的基本方法有线性列表和哈希表两种，线性列表实现对应线性查找，哈希表实现对应散列查找

##### 4. 文件分配方式

顺序分配（连续分配）：每个文件在磁盘上占用一组连续的块，支持顺序访问和直接访问（删除文件后存在空闲块，可能无法被新的文件使用）

链接分配：每一个块都有指向下一个磁盘块的指针（例如 FAT：文件分配表，里面存储了每一个块下一块的指针）

**多级索引分配（I-node）**：
系统将文件的所有盘块的盘块号集中放在一起组成一张索引块。文件的属性保存在 inode 中，inode 记录着文件数据所在 block 块的编号。

① 文件索引磁盘地址表=直接块号+一级索引+二级索引+三级索引
② 若磁盘块大小512字节，每个磁盘地址占2字节，因此一个一级索引可容纳256个磁盘地址。同样地，一个二级索引表可容纳256个一级索引表地址，一个三级索引表可容纳256个二级索引表地址

##### 5. 空闲块的管理

空闲表法：系统为外存上的所有空闲区建立一张空闲盘块表，每个空闲区对应一个空闲表项（包括表项序号、该空闲区第一个盘块号、该空闲区的盘块数量等信息）

空闲链表法：将所有空闲盘区形成一条空闲链表（从链首分配、链尾添加）

位示图法：每个二进制位对应一个盘块，0代表盘块空闲，1代表盘块已分配

**成组链接法**：结合了空闲表法和空闲链接法
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200527102209635.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzkxNDYwNA==,size_16,color_FFFFFF,t_70)

#### I/O 管理

##### 1. I/O 控制方式

程序控制 I/O：CPU忙等待检测I/O设备是否完成命令

中断驱动式 I/O：允许 I/O 设备主动打断 CPU 的运行并请求服务

DMA 方式：完全由硬件执行 I/O 交换，DMA控制器从 CPU 完全接管对总线的控制，数据交换不经过 CPU，而直接在内存和 I/O 设备之间进行。CPU 只需在 DMA 启动和结束时参与

通道控制方式：DMA 的扩展，I/O 通道指专门负责输入输出的处理机，CPU 需要进程 I/O 操作时，只需要向 I/O 通道发送一条 I/O 指令即可

##### 2. 缓存与缓冲区

平衡 CPU 和 I/O 设备之间的速率

**缓冲技术**

单缓冲：在设备和处理机之间设置一个缓冲区，两者之间交换数据时，先将数据放入缓冲区然后需要数据的设备或处理机从缓冲区取走数据

双缓冲：在设备和处理机之间设置两个缓冲区，两个缓冲区交替工作，避免了传送大量数据时的等待时间。两个缓冲区还可以实现双向数据传输

循环缓冲：多个大小相等的缓冲区组成一个循环的链表，设备和处理机交换数据时，缓冲区链表按顺序使用，避免了设备等待缓冲区变空的时间

缓冲池：由多个公用的缓冲区组成（按其使用情况可分为三个队列：空缓冲队列、装满输入数据的缓冲队列、装满输出数据的缓冲队列；还有四种缓冲区：用于收容输入数据的工作缓冲区、用于提取输入数据的工作缓冲区、用于收容输出数据的工作缓冲区、用于提取输出数据的工作缓冲区）

##### 3. 磁盘调度

先来先服务算法（FCFS）：根据进程访问磁盘的先后顺序进程调度

最短寻道优先（FFS）：优先处理磁道与当前磁头所在磁道最近的访问请求

电梯算法（Elevator）：从当前臂移动方向选择离臂最近的柱面访问，直到当前方向没有需要访问的柱面，然后臂改变方向再选择离臂最近的柱面访问，直到所有柱面访问结束。(若磁头一开始无方向，是静止的，则找最近的柱面移动)
